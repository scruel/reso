(()=>{var e={};e.id=70,e.ids=[70],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},8228:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>d,routeModule:()=>p,serverHooks:()=>m,workAsyncStorage:()=>u,workUnitAsyncStorage:()=>l});var a={};r.r(a),r.d(a,{GET:()=>c});var s=r(2706),i=r(8203),n=r(5994),o=r(9187);async function c(e){try{let t=e.url.replace("/api/analytics",""),[r,a,s]=await Promise.all([fetch(`${t}/api/log-search`),fetch(`${t}/api/log-click`),fetch(`${t}/api/client-log`)]),i=await r.json(),n=await a.json(),c=await s.json(),p=i.data||[],u=n.data||[],l=c.data||[],m=new Set([...p.map(e=>e.sessionId),...u.map(e=>e.sessionId),...l.map(e=>e.userId)]).size,d=u.reduce((e,t)=>(e[t.category]=(e[t.category]||0)+1,e),{}),g=Object.entries(d).map(([e,t])=>({category:e,count:t})).sort((e,t)=>t.count-e.count).slice(0,5),y=p.reduce((e,t)=>(t.query&&t.query.trim()&&(e[t.query]=(e[t.query]||0)+1),e),{}),w=Object.entries(y).map(([e,t])=>({query:e,count:t})).sort((e,t)=>t.count-e.count).slice(0,5),h=u.reduce((e,t)=>{let r=t.productId;return e[r]||(e[r]={productId:t.productId,title:t.title,count:0}),e[r].count++,e},{}),v=Object.values(h).sort((e,t)=>t.count-e.count).slice(0,5),x=new Date,f=e=>new Date(x.getTime()-36e5*e),j=Array.from({length:24},(e,t)=>{let r=f(23-t),a=f(22-t),s=p.filter(e=>{let t=new Date(e.timestamp);return t>=r&&t<a}).length,i=u.filter(e=>{let t=new Date(e.timestamp);return t>=r&&t<a}).length,n=l.filter(e=>{let t=new Date(e.timestamp);return"pageview"===e.type&&t>=r&&t<a}).length;return{timestamp:r.toISOString(),searches:s,clicks:i,pageviews:n}}),k=[...p.map(e=>({type:"search",timestamp:e.timestamp,details:e})),...u.map(e=>({type:"click",timestamp:e.timestamp,details:e})),...l.filter(e=>"pageview"===e.type).map(e=>({type:"pageview",timestamp:e.timestamp,details:e}))].sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime()).slice(0,20),q={summary:{totalSearches:p.length,totalClicks:u.length,totalClientEvents:l.length,uniqueUsers:m,topCategories:g,topSearchQueries:w,topClickedProducts:v},timeline:j,recentActivity:k};return o.NextResponse.json({success:!0,data:q,generatedAt:new Date().toISOString()})}catch(e){return console.error("分析數據錯誤:",e),o.NextResponse.json({success:!1,error:"Failed to generate analytics data"},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/analytics/route",pathname:"/api/analytics",filename:"route",bundlePath:"app/api/analytics/route"},resolvedPagePath:"/Users/alichen/Downloads/agent_workspace/ecommerce-search-main/frontend/src/app/api/analytics/route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:u,workUnitAsyncStorage:l,serverHooks:m}=p;function d(){return(0,n.patchFetch)({workAsyncStorage:u,workUnitAsyncStorage:l})}},6487:()=>{},8335:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[989,452],()=>r(8228));module.exports=a})();